# 스프링 DB 접근 기술

**스프링 데이터 엑세스**

---

### H2 데이터베이스 설치

- 개발이나 테스트 용도로 가볍고 편리한 DB, 웹 화면 제공

<br>

- **다운로드 및 설치**: h2 데이터베이스 버전은 스프링 부트 버전에 맞춘다.

- **실행**: ```./h2.bat```

- **데이터베이스 파일 생성 방법**
    - ```jdbc:h2:~/test``` (최초 한 번)
    - **```~/test.mv.db``` 파일 생성 확인**
    - 이후부터는 ```jdbc:h2:tcp://localhost/~/test``` 이렇게 접속

<br>

- **테이블 생성하기**

    - 테이블 관리를 위해 프로젝트 루트에 ```sql/ddl.sql``` 파일을 생성

    ```sql
    drop table if exists member CASCADE;
    create table member(
        id bigint generated by default as identity,
        name varchar(255),
        primary key (id)
    );
    ```

    - **```generated by default as identity```: ```NULL``` 값으로 INSERT 하면 DB가 자동으로 ```id``` 값을 채워준다.**

    - H2 데이터베이스에 접근해서 ```member``` 테이블 생성

---

### 순수 Jdbc

#### 환경설정

- **build.gradle 파일에 jdbc, h2 데이터베이스 관련 라이브러리 추가**
    1. Java는 DB와 붙으려면(연동하려면) ```jdbc-driver```가 꼭 있어야 한다. 
    2. Java가 DB와 붙을 때 DB가 제공하는 Client

- **스프링 부트 데이터베이스 연결 설정 추가**

    ```java
    spring.datasource.url= ... //경로
    spring.datasource.driver-class-name= ...
    spring.datasource.username= ...

    ```

<br>

#### Jdbc 리포지토리 구현

```java
...
private Connection getConnection(){
    return DataSourceUtils.getConnection(dataSource);
}

...

private void close(Connection conn) throws SQLException{
    DataSourceUtils.releaseConnection(conn, dataSource);
}
...
```

- Spring에서 Connection을 가져오고 닫을 때는 DB Transaction에 걸리지 않게 유지시켜주기 위해 꼭 이렇게 해야 한다.

<br>

#### 스프링 설정 변경

- **Spring의 장점**
: 애플리케이션 설정 코드/어셈블리 코드(=조립하는 코드)**만** 손대면 나머지 실제 애플리케이션에 관련된 코드는 하나도 손댈게 **없다**.

- ```DataSource```는 데이터베이스 커넥션을 획득할 때 사용하는 객체다. 스프링 부트는 데이터베이스 커넥션 정보를 바탕으로 ```DataSource```를 생성하고 스프링 빈으로 만들어준다. 그래서 DI를 받을 수 있다.

<br>

#### 객체지향적 설계

- **다형성**
- **개방-폐쇄 원칙(OCP, Open-Closed Principle)**
    - 확장에는 열려있고, 수정/변경에는 닫혀있다.
- 스프링 DI을 사용하면 **기존 코드를 전혀 손대지 않고, 설정만으로 구현 클래스를 변경**할 수 있다.

---

### 스프링 통합 테스트

- 스프링 컨테이너와 DB까지 연결한 통합 테스트
    - 보통은 운영 DB와 테스트 전용 DB를 분리

#### 회원 서비스 스프링 통합 테스트

- 통합 테스트보다는 단위 테스트가 더 좋을 확률이 높다.
- 따라서 **단위 테스트를 할 수 있는 능력**과, **스프링 컨테이너 없이 테스트 할 수 있는 능력**을 훈련해야 한다.
- 스프링 컨테이너가 있는 테스트는 테스트 설계가 잘못되었을 확률이 높다.

<br>

- ```@SpringBootTest```: 스프링 컨테이너와 테스트를 함께 실행한다.
- **```@Transactional```**:
    - **"테스트는 반복할 수 있어야 한다."**
    - 테스트 케이스에 이 Annotation이 있으면, 테스트 시작 전에 트랜잭션을 시작하고, 테스트 완료 후에 항상 롤백한다. 이렇게 하면 DB에 데이터가 남지 않으므로 다음 테스트에 영향을 주지 않는다.

---

### 스프링 JdbcTemplate

- **실무에서 많이 사용한다.**
- 순수 Jdbc와 동일한 환경설정을 하면 된다.
- 스프링 JdbcTemplate과 MyBatis 같은 라이브러리는 JDBC API에서 본 반복 코드를 대부분 제거해준다. 하지만 SQL은 직접 작성해야 한다.

<br>

- ```JdbcTemplate```
    - Template Method 패턴을 사용한다.
    - Injection을 직접 못하기 때문에 ```datasource```를 인자로 넣어주어야 한다.

- ```withTableName```, ```usingGeneratedKeyColumns```: 이 메소드들을 사용하면 Query문을 작성할 이유가 없다.

- ```private RowMapper<Member> memberRowMapper()```: 객체 생성과 관련 (Callback 함수)

<br>

#### JdbcTemplate을 사용하도록 스프링 설정 변경

---

### JPA

- **MyBatis**와 비교하여 국내에서는 비슷하지만, **전세계적으로는 JPA가 압도적**이다.
- JPA는 기존의 반복 코드는 물론이고, **기본적인 SQL도 JPA가 직접 만들어서 실행**해준다.
- JPA를 사용하면, SQL과 데이터 중심의 설계에서 **객체 중심의 설계로 패러다임을 전환**할 수 있다.
- JPA를 사용하면 개발 생산성을 크게 높일 수 있다.

<br>

#### ```build.gradle``` 파일에 JPA, h2 데이터베이스 관련 라이브러리 추가

- ```spring-boot-starter-jdbc``` -> ```spring-boot-starter-data-jpa```

<br>

#### 스프링 부트에 JPA 설정 추가

- ```show-sql```: JPA가 생성하는 SQL을 출력한다.
- ```ddl-auto```: JPA는 테이블을 자동으로 생성하는 기능을 제공하는데 ```none```을 사용하면 해당 기능을 끈다.
    - ```create```를 사용하면 엔티티 정보를 바탕으로 테이블도 직접 생성해준다.

<br>

#### JPA 엔티티 매핑

- JPA는 **인터페이스**
- **구현체**는 Hibernate, Eclipse 등이 있지만 주로 Hibernate를 많이 사용
- JPA는 **ORM**이라는 기술

<br>

- ```@Entity```: DB와의 Mapping은 Annotation으로 한다. (JPA가 관리하는 Entity라는 의미이다.)
- ```@Id @GeneratedValue(strategy = GenerationType.IDENTITY)```: Query에 ID를 넣는 게 아니라, DB에 값을 넣으면 DB가 ID를 자동으로 생성해주는데, 이것을 IDENTITY 전략이라고 한다.

<br>

#### JPA 회원 리포지토리

- ```private final EntityManager em;```
    - JPA는 ```EntityManager```로 모든 것이 동작을 한다. Spring Boot에 의해 자동으로 생성된 ```em```을 Injection만 해주면 된다.
- ```em.persist()```
- ```em.find(조회할 type, Primary Key)```
- **JPQL**: 객체를 대상으로 날리는 Query이며, SQL로 번역이 가능하다.
    - ```em.createQuery("select m from Member m where m.name = :name", Member.class)```
    - CRUD는 자동으로 해주기 때문에 SQL문을 작성할 필요가 없고, PK 기반이 아닌 것들에만 JPQL로 작성한다.

<br>

#### 서비스 계층에 트랜잭션 추가

- **JPA를 사용하려면 늘 트랜잭션이라는 것이 있어야 한다.**
- **JPA를 통한 모든 데이터 변경은 트랜잭션 안에서 실행해야 한다.**

<br>

#### JPA를 사용하도록 스프링 설정 변경

---

### 스프링 데이터 JPA