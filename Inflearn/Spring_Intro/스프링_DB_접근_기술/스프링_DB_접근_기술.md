# 스프링 DB 접근 기술

**스프링 데이터 엑세스**

---

### H2 데이터베이스 설치

- 개발이나 테스트 용도로 가볍고 편리한 DB, 웹 화면 제공

<br>

- **다운로드 및 설치**: h2 데이터베이스 버전은 스프링 부트 버전에 맞춘다.

- **실행**: ```./h2.bat```

- **데이터베이스 파일 생성 방법**
    - ```jdbc:h2:~/test``` (최초 한 번)
    - **```~/test.mv.db``` 파일 생성 확인**
    - 이후부터는 ```jdbc:h2:tcp://localhost/~/test``` 이렇게 접속

<br>

- **테이블 생성하기**

    - 테이블 관리를 위해 프로젝트 루트에 ```sql/ddl.sql``` 파일을 생성

    ```sql
    drop table if exists member CASCADE;
    create table member(
        id bigint generated by default as identity,
        name varchar(255),
        primary key (id)
    );
    ```

    - **```generated by default as identity```: ```NULL``` 값으로 INSERT 하면 DB가 자동으로 ```id``` 값을 채워준다.**

    - H2 데이터베이스에 접근해서 ```member``` 테이블 생성

---

### 순수 Jdbc

#### 환경설정

- **build.gradle 파일에 jdbc, h2 데이터베이스 관련 라이브러리 추가**
    1. Java는 DB와 붙으려면(연동하려면) ```jdbc-driver```가 꼭 있어야 한다. 
    2. Java가 DB와 붙을 때 DB가 제공하는 Client

- **스프링 부트 데이터베이스 연결 설정 추가**

    ```java
    spring.datasource.url= ... //경로
    spring.datasource.driver-class-name= ...
    spring.datasource.username= ...

    ```

<br>

#### Jdbc 리포지토리 구현

```java
...
private Connection getConnection(){
    return DataSourceUtils.getConnection(dataSource);
}

...

private void close(Connection conn) throws SQLException{
    DataSourceUtils.releaseConnection(conn, dataSource);
}
...
```

- Spring에서 Connection을 가져오고 닫을 때는 DB Transaction에 걸리지 않게 유지시켜주기 위해 꼭 이렇게 해야 한다.

<br>

#### 스프링 설정 변경

- **Spring의 장점**
: 애플리케이션 설정 코드/어셈블리 코드(=조립하는 코드)**만** 손대면 나머지 실제 애플리케이션에 관련된 코드는 하나도 손댈게 **없다**.

- ```DataSource```는 데이터베이스 커넥션을 획득할 때 사용하는 객체다. 스프링 부트는 데이터베이스 커넥션 정보를 바탕으로 ```DataSource```를 생성하고 스프링 빈으로 만들어준다. 그래서 DI를 받을 수 있다.

<br>

#### 객체지향적 설계

- **다형성**
- **개방-폐쇄 원칙(OCP, Open-Closed Principle)**
    - 확장에는 열려있고, 수정/변경에는 닫혀있다.
- 스프링 DI을 사용하면 **기존 코드를 전혀 손대지 않고, 설정만으로 구현 클래스를 변경**할 수 있다.

---

### 스프링 통합 테스트

- 스프링 컨테이너와 DB까지 연결한 통합 테스트
    - 보통은 운영 DB와 테스트 전용 DB를 분리

#### 회원 서비스 스프링 통합 테스트

- 통합 테스트보다는 단위 테스트가 더 좋을 확률이 높다.
- 따라서 **단위 테스트를 할 수 있는 능력**과, **스프링 컨테이너 없이 테스트 할 수 있는 능력**을 훈련해야 한다.
- 스프링 컨테이너가 있는 테스트는 테스트 설계가 잘못되었을 확률이 높다.

<br>

- ```@SpringBootTest```: 스프링 컨테이너와 테스트를 함께 실행한다.
- **```@Transactional```**:
    - **"테스트는 반복할 수 있어야 한다."**
    - 테스트 케이스에 이 Annotation이 있으면, 테스트 시작 전에 트랜잭션을 시작하고, 테스트 완료 후에 항상 롤백한다. 이렇게 하면 DB에 데이터가 남지 않으므로 다음 테스트에 영향을 주지 않는다.

---

### 스프링 JdbcTemplate

- **실무에서 많이 사용한다.**
- 순수 Jdbc와 동일한 환경설정을 하면 된다.
- 스프링 JdbcTemplate과 MyBatis 같은 라이브러리는 JDBC API에서 본 반복 코드를 대부분 제거해준다. 하지만 SQL은 직접 작성해야 한다.

<br>

- ```JdbcTemplate```
    - Template Method 패턴을 사용한다.
    - Injection을 직접 못하기 때문에 ```datasource```를 인자로 넣어주어야 한다.

- ```withTableName```, ```usingGeneratedKeyColumns```: 이 메소드들을 사용하면 Query문을 작성할 이유가 없다.

- ```private RowMapper<Member> memberRowMapper()```: 객체 생성과 관련 (Callback 함수)

<br>

#### JdbcTemplate을 사용하도록 스프링 설정 변경

---

### JPA

---

### 스프링 데이터 JPA